name: Test netstandard

on:
  push:
    paths-ignore:
    - 'doc/**'
    - 'img/**'
    - 'changelog.md'
    - 'readme.md'
  pull_request:

jobs:
  test-netstandard:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    
    strategy:
      matrix:
        netstandard-version: ['netstandard2.0', 'netstandard2.1']
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: |
          8.0.x
          9.0.x
    
    - name: Patch build to test ${{ matrix.netstandard-version }}
      run: |
        # Patch Markdig.Tests.csproj to target net8.0 only
        sed -i 's/<TargetFrameworks>net8.0;net9.0<\/TargetFrameworks>/<TargetFrameworks>net8.0<\/TargetFrameworks>/' src/Markdig.Tests/Markdig.Tests.csproj
        
        # Patch Markdig.targets to only build the target netstandard version
        sed -i 's/<TargetFrameworks>net462;netstandard2.0;netstandard2.1;net8.0;net9.0<\/TargetFrameworks>/<TargetFrameworks>${{ matrix.netstandard-version }}<\/TargetFrameworks>/' src/Markdig/Markdig.targets
        
        # Show the changes for verification
        echo "=== Testing ${{ matrix.netstandard-version }} ==="
        echo "=== Markdig.Tests.csproj changes ==="
        grep -E "TargetFrameworks|LangVersion" src/Markdig.Tests/Markdig.Tests.csproj
        echo "=== Markdig.targets changes ==="
        grep "TargetFrameworks" src/Markdig/Markdig.targets
    
    - name: Restore dependencies
      run: dotnet restore src/Markdig.Tests/Markdig.Tests.csproj
    
    - name: Build test project
      run: dotnet build src/Markdig.Tests/Markdig.Tests.csproj --configuration Release --no-restore
    
    - name: Run tests
      run: dotnet test src/Markdig.Tests/Markdig.Tests.csproj --configuration Release --no-build --verbosity normal
